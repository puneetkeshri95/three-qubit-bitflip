<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Error Correction Interface</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="logo-3d">
                        <span class="logo-text">01</span>
                    </div>
                    <div>
                        <h1>Quantum Error Correction</h1>
                        <p class="header-subtitle">3-Qubit Bit-Flip Error Correction System</p>
                    </div>
                </div>
                <div class="status-badge">
                    <span class="status-dot"></span>
                    Server Running
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-wrapper">
        <div class="container">
            <div class="content-grid">
                <!-- Left Column: Control Panel + File Management -->
                <div>
                    <!-- Control Panel -->
                    <div class="card slide-up">
                        <div class="card-header">
                            <span class="card-icon">üéõÔ∏è</span>
                            <div>
                                <h2 class="card-title">Control Panel</h2>
                                <p class="card-subtitle">Configure quantum parameters</p>
                            </div>
                        </div>

                    <!-- Initial State Selection -->
                    <div class="form-group">
                        <label class="form-label" for="initial-state">Initial Quantum State</label>
                        <select id="initial-state" class="form-select">
                            <option value="0">|0‚ü© - Ground State</option>
                            <option value="1">|1‚ü© - Excited State</option>
                        </select>
                    </div>

                    <!-- Error Qubit Selection -->
                    <div class="form-group">
                        <label class="form-label" for="error-qubit">Error Qubit Position</label>
                        <select id="error-qubit" class="form-select">
                            <option value="random">üé≤ Random (Surprise Me!)</option>
                            <option value="0">Qubit 0</option>
                            <option value="1" selected>Qubit 1</option>
                            <option value="2">Qubit 2</option>
                        </select>
                    </div>

                    <!-- Number of Shots -->
                    <div class="form-group">
                        <label class="form-label" for="shots">Number of Shots</label>
                        <input type="number" id="shots" class="form-input" value="1000" min="100" max="10000" step="100">
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-group">
                        <button class="btn btn-primary btn-block btn-lg" onclick="runPipeline()">
                            <span>‚ñ∂Ô∏è</span>
                            Run Error Correction
                        </button>
                    </div>

                    <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="encodeQubit()">
                            Encode Only
                        </button>
                        <button class="btn btn-secondary" onclick="testRandomError()">
                            üé≤ Random Error
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-secondary btn-block" onclick="getStatevector()">
                            View Statevector
                        </button>
                    </div>

                    </div>

                    <!-- File Management Card (Blob API) -->
                    <div class="card slide-up" style="margin-top: var(--spacing-lg);">
                        <div class="card-header">
                            <span class="card-icon">üìÅ</span>
                            <div>
                                <h2 class="card-title">File Management</h2>
                                <p class="card-subtitle">Local Blob API - Upload & Download</p>
                            </div>
                        </div>

                        <div style="padding: 1.5rem;">
                            <!-- Upload Section -->
                            <div class="upload-section">
                                <label class="upload-label">
                                    <span>üì§ Upload File</span>
                                    <input type="file" id="file-input" style="display: none;" onchange="handleFileSelect(event)">
                                </label>
                                <button class="btn-secondary" onclick="document.getElementById('file-input').click()">
                                    <span>üìé</span> Choose File
                                </button>
                                <button class="btn-primary" id="upload-btn" onclick="uploadFile()" disabled>
                                    <span>üì§</span> Upload
                                </button>
                            </div>

                            <div id="upload-status" style="margin-top: 1rem; display: none;"></div>

                            <!-- Files List Section -->
                            <div style="margin-top: 2rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h3 style="color: var(--text-primary); font-size: 1rem; font-weight: 600;">Uploaded Files</h3>
                                    <button class="btn-secondary btn-sm" onclick="refreshFileList()">
                                        <span>üîÑ</span> Refresh
                                    </button>
                                </div>
                                
                                <div id="files-list" class="files-list">
                                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                                        No files uploaded yet. Upload a file to get started.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Results Panel -->
                <div class="results-container slide-up">
                    <!-- Success Alert -->
                    <div class="alert alert-success" id="success-alert" style="display: none;">
                        <span class="alert-icon">‚úÖ</span>
                        <div>
                            <strong>Success!</strong> Error correction completed successfully.
                        </div>
                    </div>

                    <!-- Statistics Card -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-icon">üìä</span>
                            <div>
                                <h2 class="card-title">Results</h2>
                                <p class="card-subtitle">Quantum simulation statistics</p>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-label">Initial State</div>
                                <div class="stat-value" id="stat-initial">|0‚ü©</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Error Qubit</div>
                                <div class="stat-value" id="stat-error">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Success Rate</div>
                                <div class="stat-value success" id="stat-success">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Corrected</div>
                                <div class="stat-value" id="stat-corrected">-</div>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Error Correction Success</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill" style="width: 0%;">0%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Measurements Card -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-icon">üìà</span>
                            <div>
                                <h2 class="card-title">Measurements</h2>
                                <p class="card-subtitle">Quantum state measurements</p>
                            </div>
                        </div>

                        <!-- Visualization Canvas -->
                        <div style="margin-bottom: 1.5rem; min-height: 300px; position: relative; background: #1e293b; border-radius: 8px; padding: 10px;">
                            <canvas id="measurements-chart" width="400" height="300" style="display: block; box-sizing: border-box; height: 300px; width: 400px;"></canvas>
                        </div>

                        <!-- Table View -->
                        <table class="measurements-table" id="measurements-table">
                            <thead>
                                <tr>
                                    <th>State</th>
                                    <th>Count</th>
                                    <th>Probability</th>
                                    <th>Visualization</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--text-muted);">
                                        No measurements yet. Run a simulation to see results.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Circuit Diagram Card -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-icon">üîÑ</span>
                            <div>
                                <h2 class="card-title">Quantum Circuit</h2>
                                <p class="card-subtitle">Visual representation</p>
                            </div>
                            <button class="btn-export" id="export-circuit-btn" onclick="exportCircuit()" disabled title="Run a simulation first to export">
                                <span>üì•</span> Export Circuit
                            </button>
                        </div>

                        <div class="circuit-diagram" id="circuit-diagram">
                            <pre>No circuit generated yet. Run a simulation to see the circuit.</pre>
                        </div>
                    </div>

                    <!-- Statevector Visualization Card -->
                    <div class="card" id="statevector-card" style="display: none;">
                        <div class="card-header">
                            <span class="card-icon">üåä</span>
                            <div>
                                <h2 class="card-title">Statevector Analysis</h2>
                                <p class="card-subtitle">Quantum state probabilities</p>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem; min-height: 250px; position: relative; background: #1e293b; border-radius: 8px; padding: 10px;">
                            <canvas id="statevector-chart" width="400" height="250" style="display: block; box-sizing: border-box; height: 250px; width: 400px;"></canvas>
                        </div>

                        <div class="tabs" id="statevector-tabs">
                            <button class="tab active" onclick="showStatevectorStage('initial')">Initial</button>
                            <button class="tab" onclick="showStatevectorStage('encoded')">Encoded</button>
                            <button class="tab" onclick="showStatevectorStage('with_error')">With Error</button>
                            <button class="tab" onclick="showStatevectorStage('corrected')">Corrected</button>
                        </div>

                        <div id="statevector-info" class="mt-2" style="color: var(--text-secondary); font-size: 0.875rem;">
                            Select a stage to view the quantum state probabilities.
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Quantum Error Correction System | Built with Qiskit, Flask & Python</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        const API_BASE = 'http://localhost:5000';
        let measurementsChart = null;
        let statevectorChart = null;
        let currentStatevectorData = {};

        // Initialize chart
        function initChart() {
            console.log('initChart called, Chart available:', typeof Chart !== 'undefined');
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded yet');
                setTimeout(initChart, 1000);
                return;
            }
            
            const ctx = document.getElementById('measurements-chart');
            if (!ctx) {
                console.error('Canvas element not found');
                return;
            }
            
            // Destroy existing chart if it exists
            if (measurementsChart) {
                measurementsChart.destroy();
            }

            measurementsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['|000‚ü©', '|111‚ü©'],
                    datasets: [{
                        label: 'Measurement Counts',
                        data: [512, 488],
                        backgroundColor: [
                            '#3b82f6',
                            '#8b5cf6'
                        ],
                        borderColor: [
                            '#1d4ed8',
                            '#7c3aed'
                        ],
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false,
                        barThickness: 50,
                        maxBarThickness: 80
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    backgroundColor: 'transparent',
                    layout: {
                        padding: {
                            top: 20,
                            right: 20,
                            bottom: 20,
                            left: 20
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#cbd5e1',
                                font: {
                                    family: 'Inter, sans-serif',
                                    size: 12
                                }
                            }
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    if (total === 0) return ' No data yet';
                                    const percentage = ((context.parsed.y / total) * 100).toFixed(2);
                                    return ` Count: ${context.parsed.y} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#94a3b8',
                                font: {
                                    family: 'Inter, sans-serif',
                                    size: 12
                                },
                                stepSize: 100
                            },
                            grid: {
                                color: 'rgba(51, 65, 85, 0.3)',
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'Count',
                                color: '#94a3b8',
                                font: {
                                    family: 'Inter, sans-serif',
                                    size: 11
                                }
                            }
                        },
                        x: {
                            ticks: {
                                color: '#cbd5e1',
                                font: {
                                    family: 'Fira Code, monospace',
                                    size: 13,
                                    weight: '600'
                                }
                            },
                            grid: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Quantum State',
                                color: '#94a3b8',
                                font: {
                                    family: 'Inter, sans-serif',
                                    size: 11
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    }
                }
            });

            console.log('Measurements chart created successfully');

            // Initialize statevector chart
            const svCtx = document.getElementById('statevector-chart');
            if (svCtx) {
                // Destroy existing chart if it exists
                if (statevectorChart) {
                    statevectorChart.destroy();
                }
                statevectorChart = new Chart(svCtx, {
                    type: 'bar',
                    data: {
                        labels: ['|000‚ü©', '|001‚ü©', '|010‚ü©', '|011‚ü©', '|100‚ü©', '|101‚ü©', '|110‚ü©', '|111‚ü©'],
                        datasets: [{
                            label: 'Probability',
                            data: [0.5, 0, 0, 0, 0, 0, 0, 0.5],
                            backgroundColor: [
                                '#3b82f6', '#06d6a0', '#f59e0b', '#ef4444',
                                '#10b981', '#8b5cf6', '#f97316', '#84cc16'
                            ],
                            borderColor: [
                                '#1d4ed8', '#059669', '#d97706', '#dc2626',
                                '#047857', '#7c3aed', '#ea580c', '#65a30d'
                            ],
                            borderWidth: 2,
                            borderRadius: 6,
                            barThickness: 25,
                            maxBarThickness: 40
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        backgroundColor: 'transparent',
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Click "View Statevector" to see quantum state probabilities',
                                color: '#94a3b8',
                                font: {
                                    family: 'Inter, sans-serif',
                                    size: 13,
                                    weight: '400'
                                },
                                padding: {
                                    bottom: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                                titleColor: '#f1f5f9',
                                bodyColor: '#cbd5e1',
                                borderColor: '#334155',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        const prob = context.parsed.y;
                                        if (prob === 0) return ' No data yet';
                                        return ` Probability: ${(prob * 100).toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                ticks: {
                                    color: '#94a3b8',
                                    font: {
                                        family: 'Inter, sans-serif',
                                        size: 12
                                    },
                                    callback: function(value) {
                                        return (value * 100).toFixed(0) + '%';
                                    }
                                },
                                grid: {
                                    color: 'rgba(51, 65, 85, 0.3)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#cbd5e1',
                                    font: {
                                        family: 'Fira Code, monospace',
                                        size: 13,
                                        weight: '600'
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        animation: {
                            duration: 750,
                            easing: 'easeInOutQuart'
                        }
                    }
                });
                console.log('Statevector chart created successfully');
            }
        }

        // Update chart with new data
        function updateChart(measurements, totalShots) {
            console.log('updateChart called with:', measurements, totalShots);
            
            if (!measurementsChart) {
                console.log('Chart not initialized, initializing...');
                initChart();
            }
            
            if (!measurementsChart) {
                console.error('Chart not initialized');
                return;
            }

            const states = Object.keys(measurements).sort();
            const counts = states.map(state => measurements[state]);
            const maxCount = Math.max(...counts);
            
            console.log('Updating chart with states:', states, 'counts:', counts);

            measurementsChart.data.labels = states.map(s => `|${s}‚ü©`);
            measurementsChart.data.datasets[0].data = counts;
            
            // Update chart options
            measurementsChart.options.scales.y.max = Math.ceil(maxCount * 1.1);
            measurementsChart.options.plugins.title.display = false;
            
            // Force immediate chart update
            measurementsChart.update('active');
            console.log('Chart updated successfully');
        }

        // Update statevector chart with stage data
        function updateStatevectorChart(stage) {
            if (!statevectorChart || !currentStatevectorData[stage]) return;

            const stageData = currentStatevectorData[stage];
            const basisStates = ['000', '001', '010', '011', '100', '101', '110', '111'];
            const probabilities = stageData.probabilities || [];
            
            // Filter out zero probabilities for cleaner display
            const nonZeroIndices = probabilities.map((p, i) => p > 0.001 ? i : -1).filter(i => i !== -1);
            const labels = nonZeroIndices.map(i => `|${basisStates[i]}‚ü©`);
            const nonZeroProbabilities = nonZeroIndices.map(i => probabilities[i]);

            statevectorChart.data.labels = labels;
            statevectorChart.data.datasets[0].data = nonZeroProbabilities;
            
            // Hide placeholder title when showing data
            statevectorChart.options.plugins.title.display = false;
            
            statevectorChart.update('active');

            // Update info text
            const maxProb = Math.max(...nonZeroProbabilities);
            const maxIndex = nonZeroIndices[nonZeroProbabilities.indexOf(maxProb)];
            const maxState = basisStates[maxIndex];
            document.getElementById('statevector-info').innerHTML = 
                `Stage: <strong>${stage.replace('_', ' ')}</strong> | Dominant state: <strong>|${maxState}‚ü©</strong> (${(maxProb * 100).toFixed(2)}%)`;
        }

        // Show statevector stage
        function showStatevectorStage(stage) {
            // Update active tab
            document.querySelectorAll('#statevector-tabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update chart
            updateStatevectorChart(stage);
        }

        // Export circuit as text file using Blob API
        function exportCircuit() {
            const circuitElement = document.getElementById('circuit-diagram');
            const preElement = circuitElement.querySelector('pre');
            
            if (!preElement || preElement.textContent.includes('No circuit generated')) {
                alert('No circuit available to export. Please run a simulation first.');
                return;
            }

            // Get circuit text content
            const circuitText = preElement.textContent;
            
            // Get current configuration for filename
            const state = document.getElementById('stat-initial').textContent || 'unknown';
            const errorQubit = document.getElementById('stat-error').textContent || 'unknown';
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            
            // Create filename with metadata
            const filename = `quantum_circuit_${state.replace(/[|‚ü©]/g, '')}_error_${errorQubit.replace(/[üé≤\s]/g, '')}_${timestamp}.txt`;
            
            // Create header with metadata
            const header = `# Quantum Error Correction Circuit
# Generated: ${new Date().toLocaleString()}
# Initial State: ${state}
# Error Location: ${errorQubit}
# ================================================
\n`;
            
            // Combine header and circuit
            const fullContent = header + circuitText;
            
            // Create Blob with text content
            const blob = new Blob([fullContent], { type: 'text/plain;charset=utf-8' });
            
            // Create download link using Blob URL
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = filename;
            
            // Trigger download
            document.body.appendChild(downloadLink);
            downloadLink.click();
            
            // Cleanup
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
            
            // Show success feedback
            const btn = document.getElementById('export-circuit-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span>‚úÖ</span> Downloaded!';
            btn.classList.add('success');
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('success');
            }, 2000);
        }

        // Run full pipeline
        async function runPipeline() {
            const state = document.getElementById('initial-state').value;
            const errorQubitValue = document.getElementById('error-qubit').value;
            const shots = parseInt(document.getElementById('shots').value);

            const btn = event.target.closest('.btn-primary');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Running...';

            try {
                let requestBody;
                
                // Check if random error is selected
                if (errorQubitValue === 'random') {
                    requestBody = { 
                        state, 
                        random_error: true,
                        shots 
                    };
                } else {
                    requestBody = { 
                        state, 
                        error_qubit: parseInt(errorQubitValue),
                        shots 
                    };
                }

                const response = await fetch(`${API_BASE}/pipeline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.success) {
                    updateResults(data);
                    showSuccess();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to connect to server. Make sure Flask backend is running.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>‚ñ∂Ô∏è</span> Run Error Correction';
            }
        }

        // Update results display
        async function updateResults(data) {
            console.log('updateResults called with data:', data);
            const pipeline = data.pipeline;

            // Update statistics
            document.getElementById('stat-initial').textContent = `|${pipeline.initial_state}‚ü©`;
            
            // Show random indicator if error was randomly selected
            const errorText = pipeline.randomly_selected 
                ? `Q${pipeline.error_qubit} üé≤` 
                : `Q${pipeline.error_qubit}`;
            document.getElementById('stat-error').textContent = errorText;
            
            document.getElementById('stat-success').textContent = `${pipeline.success_rate.toFixed(1)}%`;
            document.getElementById('stat-corrected').textContent = pipeline.corrected ? '‚úÖ' : '‚ùå';

            // Update progress bar
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = `${pipeline.success_rate}%`;
            progressFill.textContent = `${pipeline.success_rate.toFixed(1)}%`;
            progressFill.classList.add('success');
            document.getElementById('progress-percent').textContent = `${pipeline.success_rate.toFixed(1)}%`;

            // Update measurements table
            const tbody = document.querySelector('#measurements-table tbody');
            tbody.innerHTML = '';
            const measurements = data.measurements;
            const totalShots = data.shots;
            
            console.log('Calling updateChart with measurements:', measurements, 'shots:', totalShots);

            // Update chart
            updateChart(measurements, totalShots);

            // Sort states for consistent display
            const sortedStates = Object.keys(measurements).sort();

            for (const state of sortedStates) {
                const count = measurements[state];
                const probability = (count / totalShots * 100).toFixed(2);
                
                // Create visual bar
                const barWidth = probability;
                const barColor = count === totalShots ? '#10b981' : '#6366f1';
                
                const row = `
                    <tr>
                        <td style="font-weight: 600;">|${state}‚ü©</td>
                        <td>${count}</td>
                        <td>${probability}%</td>
                        <td>
                            <div style="background: rgba(99, 102, 241, 0.1); border-radius: 4px; overflow: hidden; height: 20px;">
                                <div style="background: ${barColor}; width: ${barWidth}%; height: 100%; transition: width 0.5s ease;"></div>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }

            // Update circuit diagram
            if (data.circuit) {
                document.getElementById('circuit-diagram').innerHTML = 
                    `<pre>${data.circuit.join('\n')}</pre>`;
                
                // Enable export button
                const exportBtn = document.getElementById('export-circuit-btn');
                exportBtn.disabled = false;
                exportBtn.title = 'Download circuit as text file';
            }

            // Fetch and display statevector data
            try {
                const state = document.getElementById('initial-state').value;
                const errorQubitValue = document.getElementById('error-qubit').value;
                
                let svRequestBody;
                if (errorQubitValue === 'random') {
                    // Use the actual error qubit that was applied
                    svRequestBody = { 
                        state, 
                        error_qubit: pipeline.error_qubit 
                    };
                } else {
                    svRequestBody = { 
                        state, 
                        error_qubit: parseInt(errorQubitValue)
                    };
                }

                const svResponse = await fetch(`${API_BASE}/statevector`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(svRequestBody)
                });

                const svData = await svResponse.json();
                if (svData.success) {
                    currentStatevectorData = svData.stages;
                    
                    // Show the statevector card
                    document.getElementById('statevector-card').style.display = 'block';
                    
                    // Update chart with initial stage
                    updateStatevectorChart('initial');
                }
            } catch (error) {
                console.error('Error fetching statevector:', error);
            }
        }

        // Show success alert
        function showSuccess() {
            const alert = document.getElementById('success-alert');
            alert.style.display = 'flex';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Show success message (generic)
        function showSuccessMessage(message) {
            const alert = document.getElementById('success-alert');
            if (alert) {
                const msgElement = alert.querySelector('div div:last-child');
                const originalText = msgElement.textContent;
                msgElement.textContent = message;
                alert.style.display = 'flex';
                setTimeout(() => {
                    alert.style.display = 'none';
                    msgElement.textContent = originalText;
                }, 3000);
            }
        }

        // Encode only
        async function encodeQubit() {
            const state = document.getElementById('initial-state').value;

            try {
                const response = await fetch(`${API_BASE}/encode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ state })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`Encoded state: ${data.encoded_state}`);
                }
            } catch (error) {
                alert('Failed to connect to server.');
            }
        }

        // Test random error - runs full pipeline with random error
        async function testRandomError() {
            const state = document.getElementById('initial-state').value;
            const shots = parseInt(document.getElementById('shots').value);
            const btn = event.target;
            const originalHTML = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Running...';

            try {
                const response = await fetch(`${API_BASE}/pipeline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        state, 
                        random_error: true,
                        shots 
                    })
                });

                const data = await response.json();
                if (data.success) {
                    updateResults(data);
                    showSuccess();
                    
                    // Show which qubit was randomly selected
                    const alertDiv = document.getElementById('success-alert');
                    const msgElement = alertDiv.querySelector('div div:last-child');
                    msgElement.textContent = `Random error on Qubit ${data.pipeline.error_qubit} corrected successfully! üé≤`;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to connect to server. Make sure Flask backend is running.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // Get statevector
        async function getStatevector() {
            const state = document.getElementById('initial-state').value;
            const errorQubitValue = document.getElementById('error-qubit').value;
            const btn = event.target;
            const originalHTML = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Loading...';

            try {
                let requestBody;
                
                // Check if random error is selected
                if (errorQubitValue === 'random') {
                    requestBody = { 
                        state, 
                        random_error: true
                    };
                } else {
                    requestBody = { 
                        state, 
                        error_qubit: parseInt(errorQubitValue)
                    };
                }

                const response = await fetch(`${API_BASE}/statevector`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                if (data.success) {
                    // Store statevector data
                    currentStatevectorData = data.stages;
                    
                    // Show the statevector card
                    document.getElementById('statevector-card').style.display = 'block';
                    
                    // Reset tabs to initial stage
                    document.querySelectorAll('#statevector-tabs .tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelector('#statevector-tabs .tab:first-child').classList.add('active');
                    
                    // Update chart with initial stage
                    updateStatevectorChart('initial');
                    
                    // Show success message
                    const randomInfo = data.randomly_selected ? ` (Random Error: Q${data.error_qubit})` : '';
                    showSuccessMessage(`Statevector loaded successfully!${randomInfo}`);
                    
                    // Scroll to statevector card
                    document.getElementById('statevector-card').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    alert('Failed to load statevector: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to connect to server: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // =====================================================
        // BLOB API - FILE MANAGEMENT
        // =====================================================

        let selectedFile = null;

        // Handle file selection
        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            const uploadBtn = document.getElementById('upload-btn');
            const statusDiv = document.getElementById('upload-status');
            
            if (selectedFile) {
                uploadBtn.disabled = false;
                statusDiv.style.display = 'block';
                statusDiv.className = 'alert alert-info';
                statusDiv.innerHTML = `
                    <span class="alert-icon">üìé</span>
                    <div>
                        <strong>File selected:</strong> ${selectedFile.name} (${(selectedFile.size / 1024).toFixed(2)} KB)
                    </div>
                `;
            } else {
                uploadBtn.disabled = true;
                statusDiv.style.display = 'none';
            }
        }

        // Upload file to server
        async function uploadFile() {
            if (!selectedFile) {
                alert('Please select a file first');
                return;
            }

            const uploadBtn = document.getElementById('upload-btn');
            const statusDiv = document.getElementById('upload-status');
            const originalHTML = uploadBtn.innerHTML;

            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner"></span> Uploading...';

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);

                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.className = 'alert alert-success';
                    statusDiv.innerHTML = `
                        <span class="alert-icon">‚úÖ</span>
                        <div>
                            <strong>Upload successful!</strong><br>
                            Filename: ${data.filename}<br>
                            Size: ${data.size_formatted}
                        </div>
                    `;

                    // Reset file input
                    document.getElementById('file-input').value = '';
                    selectedFile = null;

                    // Refresh file list
                    await refreshFileList();
                } else {
                    statusDiv.className = 'alert alert-error';
                    statusDiv.innerHTML = `
                        <span class="alert-icon">‚ùå</span>
                        <div>
                            <strong>Upload failed:</strong> ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.className = 'alert alert-error';
                statusDiv.innerHTML = `
                    <span class="alert-icon">‚ùå</span>
                    <div>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = originalHTML;
            }
        }

        // Refresh file list
        async function refreshFileList() {
            const filesList = document.getElementById('files-list');
            filesList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">Loading...</p>';

            try {
                const response = await fetch(`${API_BASE}/files`);
                const data = await response.json();

                if (data.success && data.count > 0) {
                    let html = '<div class="file-items">';
                    
                    for (const file of data.files) {
                        const date = new Date(file.created).toLocaleString();
                        html += `
                            <div class="file-item">
                                <div class="file-info">
                                    <div class="file-name">üìÑ ${file.filename}</div>
                                    <div class="file-meta">${file.size_formatted} ‚Ä¢ ${date}</div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn-icon" onclick="downloadFile('${file.filename}')" title="Download">
                                        üì•
                                    </button>
                                    <button class="btn-icon danger" onclick="deleteFile('${file.filename}')" title="Delete">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    filesList.innerHTML = html;
                } else {
                    filesList.innerHTML = `
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            No files uploaded yet. Upload a file to get started.
                        </p>
                    `;
                }
            } catch (error) {
                filesList.innerHTML = `
                    <p style="color: var(--error); text-align: center; padding: 2rem;">
                        Error loading files: ${error.message}
                    </p>
                `;
            }
        }

        // Download file
        async function downloadFile(filename) {
            try {
                window.open(`${API_BASE}/download/${filename}`, '_blank');
            } catch (error) {
                alert('Download failed: ' + error.message);
            }
        }

        // Delete file
        async function deleteFile(filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/delete/${filename}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    await refreshFileList();
                } else {
                    alert('Delete failed: ' + data.error);
                }
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        }

        // Load file list on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('Initializing charts...');
                initChart();
                refreshFileList();
            }, 100);
        });
        
        // Backup initialization
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (!measurementsChart || !statevectorChart) {
                    console.log('Backup chart initialization...');
                    initChart();
                }
            }, 500);
        });

        // Shrink header on scroll
        let lastScrollTop = 0;
        window.addEventListener('scroll', () => {
            const header = document.querySelector('.header');
            const headerH1 = document.querySelector('.header h1');
            const headerSubtitle = document.querySelector('.header-subtitle');
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (scrollTop > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
            
            lastScrollTop = scrollTop;
        });
    </script>
</body>
</html>
